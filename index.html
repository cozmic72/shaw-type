<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaw Type - Shavian Typing Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 36px;
            font-weight: bold;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 18px;
            font-weight: normal;
        }

        .word-display {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .word-display .word {
            font-size: 48px;
            letter-spacing: 4px;
        }

        .word-display .char {
            display: inline-block;
            transition: all 0.2s ease;
        }

        .word-display .char.correct {
            opacity: 0.4;
            color: #28a745;
        }

        .word-display .char.incorrect {
            color: #dc3545;
            font-weight: bold;
        }

        .input-container {
            margin-bottom: 20px;
        }

        #typingInput {
            width: 100%;
            padding: 15px;
            font-size: 32px;
            border: 3px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            letter-spacing: 4px;
            transition: border-color 0.3s;
        }

        #typingInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }

        .instructions {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        .completion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .completion-modal.show {
            display: flex;
        }

        .completion-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .completion-content h2 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 20px;
        }

        .completion-content .final-score {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .completion-content .stat-row {
            margin: 10px 0;
            font-size: 18px;
            color: #666;
        }

        .level-stats-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .level-stat {
            padding: 5px 0;
            font-size: 14px;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
        }

        .level-stat:last-child {
            border-bottom: none;
        }

        .completion-content button {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .completion-content button:hover {
            background: #5568d3;
        }

        .mode-btn {
            padding: 10px 30px;
            font-size: 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: #f0f0ff;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .settings-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: #f0f0ff;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.3s ease;
        }

        .settings-content h2 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 25px;
        }

        .settings-option {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option label {
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #333;
            cursor: pointer;
        }

        .settings-option input[type="checkbox"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-option-desc {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            margin-left: 32px;
        }

        .settings-close-btn {
            margin-top: 25px;
            padding: 12px 30px;
            font-size: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .settings-close-btn:hover {
            background: #5568d3;
        }

        #lengthSelect {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .burger-menu {
            position: relative;
            display: inline-block;
        }

        .burger-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            color: #667eea;
            transition: color 0.3s;
        }

        .burger-btn:hover {
            color: #5568d3;
        }

        .burger-dropdown {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            background: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        .burger-dropdown.show {
            display: block;
        }

        .burger-dropdown a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
        }

        .burger-dropdown a:hover {
            background: #f0f0ff;
        }

        .copyright {
            text-align: center;
            color: #000000;
            font-size: 14px;
            margin-top: 20px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shaw Type</h1>
        <div class="subtitle">êëñêë±êëùêëæêëØ êëëêë≤êëêêë¶êëô êëêêëÆêë®êëíêëëêë¶êëï</div>

        <div class="mode-selector" style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 10px;">
            <div class="burger-menu">
                <button class="burger-btn" onclick="toggleBurgerMenu()">‚ò∞</button>
                <div class="burger-dropdown" id="burgerDropdown">
                    <a href="#" onclick="openContentModal('about'); return false;">About</a>
                    <a href="#" onclick="openContentModal('keyboards'); return false;">Keyboards</a>
                    <a href="#" onclick="openContentModal('resources'); return false;">Resources</a>
                    <a href="#" onclick="openSettings(); closeBurgerMenu(); return false;">Settings</a>
                </div>
            </div>
            <button id="playBtn" class="mode-btn active" onclick="setMode('play')">Play</button>
            <button id="learnBtn" class="mode-btn" onclick="setMode('learn')">Practice</button>
        </div>

        <div id="learnLevelInfo" style="display: none; text-align: center; margin-bottom: 15px;">
            <button onclick="openLessonSelector()" style="padding: 10px 20px; font-size: 14px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                Choose Lesson
            </button>
        </div>

        <div class="word-display">
            <div class="word" id="wordDisplay"></div>
        </div>

        <div class="input-container">
            <input type="text" id="typingInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-label" id="levelLabel">Level</div>
                <div class="stat-value" id="levelDisplay">1</div>
            </div>
            <div class="stat">
                <div class="stat-label">Words</div>
                <div class="stat-value" id="wordCount">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="accuracy">100%</div>
            </div>
        </div>

        <div class="instructions">
            Type the word shown above. Press Enter or Space to move to the next word.
        </div>
    </div>

    <div class="copyright">
        @2025 joro.io
    </div>

    <!-- Completion Modal -->
    <div class="completion-modal" id="completionModal">
        <div class="completion-content">
            <h2>Congratulations!</h2>
            <p>You completed 30 words!</p>
            <div class="final-score" id="finalScore">--</div>
            <div class="stat-row">Accuracy: <span id="finalAccuracy">--</span></div>
            <div class="stat-row">High Score: <span id="finalHighScore">--</span></div>
            <div class="stat-row">Level Reached: <span id="finalLevel">--</span></div>
            <div id="levelStatsContainer" class="level-stats-container"></div>
            <button onclick="resetPractice()">Practice Again</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2>Settings</h2>

            <div class="settings-option">
                <label style="display: block; margin-bottom: 10px; color: #666; font-weight: normal;">
                    English Dialect
                </label>
                <div style="display: flex; gap: 20px;">
                    <label style="cursor: pointer;">
                        <input type="radio" name="dialectSettings" value="gb" checked onchange="onDialectChangeSettings()" style="margin-right: 8px;">
                        British
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="dialectSettings" value="us" onchange="onDialectChangeSettings()" style="margin-right: 8px;">
                        American
                    </label>
                </div>
            </div>

            <div class="settings-option">
                <label style="display: block; margin-bottom: 10px; color: #666; font-weight: normal;">
                    Keyboard Layout
                </label>
                <select id="layoutSelectSettings" onchange="onLayoutChangeSettings()" style="width: 100%; padding: 8px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="imperial">Shaw Imperial</option>
                    <option value="qwerty">Shaw QWERTY</option>
                    <option value="2layer">Shaw 2-layer (shift)</option>
                    <option value="jafl">Shaw-JAFL</option>
                </select>
            </div>

            <div class="settings-option" id="ligatureSettingOption">
                <label>
                    <input type="checkbox" id="ligatureToggleSettings" onchange="onLigatureToggleSettings()">
                    <span>My keyboard auto-converts ligatures (e.g., êë©+êëÆ ‚Üí êëº)</span>
                </label>
            </div>

            <div class="settings-option">
                <label>
                    <input type="checkbox" id="shavianUIToggle" onchange="toggleShavianUI()">
                    <span>Display UI in Shavian</span>
                </label>
                <div class="settings-option-desc">Show labels and text in Shavian alphabet instead of Latin</div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <button onclick="resetWelcomeScreen()" style="width: 100%; padding: 12px; font-size: 14px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; margin-bottom: 15px;">
                    Show Welcome Screen Again
                </button>
            </div>

            <button class="settings-close-btn" onclick="closeSettings()">Close</button>
        </div>
    </div>

    <!-- Content Modal -->
    <div class="settings-modal" id="contentModal">
        <div class="settings-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <h2 id="contentModalTitle">Content</h2>
            <div id="contentModalBody" style="margin-top: 20px;">
                Loading...
            </div>
            <button class="settings-close-btn" onclick="closeContentModal()">Close</button>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="settings-modal" id="welcomeModal">
        <div class="settings-content" style="max-width: 600px;">
            <h2>Welcome to Shaw Type!</h2>
            <p style="margin: 15px 0; color: #666;">Choose your preferences to get started:</p>

            <div class="settings-option">
                <label style="display: block; margin-bottom: 10px; color: #666; font-weight: normal;">
                    English Dialect
                </label>
                <div style="display: flex; gap: 20px;">
                    <label style="cursor: pointer;">
                        <input type="radio" name="dialectWelcome" value="gb" checked onchange="onDialectChangeWelcome()" style="margin-right: 8px;">
                        British
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="dialectWelcome" value="us" onchange="onDialectChangeWelcome()" style="margin-right: 8px;">
                        American
                    </label>
                </div>
            </div>

            <div class="settings-option">
                <label style="display: block; margin-bottom: 10px; color: #666; font-weight: normal;">
                    Keyboard Layout
                </label>
                <select id="layoutSelectWelcome" onchange="onLayoutChangeWelcome()" style="width: 100%; padding: 8px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="imperial">Shaw Imperial</option>
                    <option value="qwerty">Shaw QWERTY</option>
                    <option value="2layer">Shaw 2-layer (shift)</option>
                    <option value="jafl">Shaw-JAFL</option>
                </select>
            </div>

            <div class="settings-option" id="ligatureWelcomeOption">
                <label>
                    <input type="checkbox" id="ligatureToggleWelcome" checked onchange="onLigatureToggleWelcome()">
                    <span>Automatic ligatures (êë©+êëÆ‚Üíêëº, êëò+êëµ‚Üíêëø)</span>
                </label>
            </div>

            <div class="settings-option">
                <label>
                    <input type="checkbox" id="shavianUIToggleWelcome" onchange="toggleShavianUIWelcome()">
                    <span>Display UI in Shavian</span>
                </label>
            </div>

            <button class="settings-close-btn" onclick="closeWelcomeModal()" style="margin-top: 25px; width: 100%;">Start</button>
        </div>
    </div>

    <!-- Lesson Selector Modal -->
    <div class="settings-modal" id="lessonModal">
        <div class="settings-content" style="max-width: 500px;">
            <h2>Choose a Lesson</h2>
            <p style="margin: 15px 0; color: #666;">Select a lesson to practice:</p>

            <div id="lessonList" style="margin: 20px 0;">
                <!-- Lessons will be populated dynamically -->
            </div>

            <button class="settings-close-btn" onclick="closeLessonModal()">Cancel</button>
        </div>
    </div>

    <script>
        // Words will be loaded from JSON file
        let wordsByLength = {};
        let learnWordsImperial = {};
        let learnWordsImperialNoLig = {};
        let learnWordsQwerty = {};
        let learnWords2layer = {};
        let learnWordsJafl = {};
        let learnWordsJaflNoLig = {};
        let learnWordsCompound = {};
        let wordsLoaded = false;

        let currentWord = '';
        let wordsCompleted = 0;
        let currentLevel = 1;
        let totalLettersTyped = 0;
        let correctLetters = 0;
        let recentWords = []; // Track recent words to avoid repeats
        let highScore = 0; // High score from localStorage
        let levelStats = []; // Per-level statistics
        let currentLevelLettersTyped = 0; // Letters typed in current level
        let currentLevelCorrectLetters = 0; // Correct letters in current level

        // Ligature mappings
        const LIGATURES = {
            'êëº': ['êë©', 'êëÆ'], // ER
            'êë∏': ['êë≠', 'êëÆ'], // AR
            'êëπ': ['êë∑', 'êëÆ'], // OR
            'êëø': ['êëò', 'êëµ'], // YEW
            'êëΩ': ['êëæ', 'êëÆ']  // AIR
        };

        // Reverse mapping: component pairs to compound
        const COMPONENT_TO_LIGATURE = {};
        Object.keys(LIGATURES).forEach(compound => {
            const [first, second] = LIGATURES[compound];
            const key = first + second;
            COMPONENT_TO_LIGATURE[key] = compound;
        });

        // Expand a string, replacing compound ligatures with their components
        function expandLigatures(str) {
            const chars = Array.from(str);
            const expanded = [];
            chars.forEach(char => {
                if (LIGATURES[char]) {
                    expanded.push(...LIGATURES[char]);
                } else {
                    expanded.push(char);
                }
            });
            return expanded;
        }

        // Check if input matches expected, considering ligature equivalence
        function matchesWithLigatures(inputChars, expectedChars, index) {
            // Get the expanded forms for comparison
            const expectedExpanded = expandLigatures(expectedChars.join(''));
            const inputExpanded = expandLigatures(inputChars.join(''));

            // Check if input (up to index) matches expected
            for (let i = 0; i <= index && i < inputExpanded.length; i++) {
                if (i >= expectedExpanded.length) return false;
                if (inputExpanded[i] !== expectedExpanded[i]) return false;
            }
            return true;
        }

        // Check if the current input could be a partial ligature match
        function isPartialLigatureMatch(inputChars, expectedChars, inputIndex) {
            const inputExpanded = expandLigatures(inputChars.join(''));
            const expectedExpanded = expandLigatures(expectedChars.join(''));

            // If we're in the middle of potentially typing a ligature, don't mark as error yet
            if (inputIndex < inputExpanded.length && inputIndex < expectedExpanded.length) {
                return inputExpanded[inputIndex] === expectedExpanded[inputIndex];
            }
            return true;
        }

        // Mode management
        let currentMode = 'play'; // 'learn' or 'play'
        let currentLayout = 'imperial'; // 'imperial' or 'qwerty'
        let useLigatures = true; // Toggle for ligatures
        let selectedLevel = 'auto'; // Level selection: 'auto' or 1-7
        let useShavianUI = false; // Toggle for Shavian UI
        let currentDialect = 'gb'; // 'gb' or 'us' - English dialect for word lists

        // UI text translations
        const translations = {
            latin: {
                title: 'Shaw Type',
                subtitle: 'êëñêë±êëùêëæêëØ êëëêë≤êëêêë¶êëô êëêêëÆêë®êëíêëëêë¶êëï',
                practice: 'Practice',
                play: 'Play',
                settings: 'Settings',
                keyboardLayout: 'Keyboard Layout',
                ligatures: 'Automatic ligatures (êë©+êëÆ‚Üíêëº, êëò+êëµ‚Üíêëø)',
                lesson: 'Lesson:',
                auto: 'Auto (progress based)',
                wordLength: 'Word Length:',
                characters: 'characters',
                // Word length options
                length1: '1 character',
                length2: '2 characters',
                length3: '3 characters',
                length4: '4 characters',
                length5: '5 characters',
                length6: '6 characters',
                length7: '7 characters',
                length46: '4-6 characters',
                length57: '5-7 characters',
                lesson_label: 'Lesson',
                level_label: 'Level',
                words: 'Words',
                accuracy: 'Accuracy',
                // Lesson names - Imperial
                lessonHomeRowCenter: 'Home Row Center',
                lessonFullHomeRow: 'Full Home Row',
                lessonIndexFingerReach: 'Index Finger Reach',
                lessonUpperLowerRows: 'Upper & Lower Rows',
                lessonAlmostComplete: 'Almost Complete',
                lessonAllKeys: 'All Keys',
                lessonCompoundLetters: 'Compound Letters',
                // Lesson names - QWERTY
                lessonHomeRowShift: 'Home Row + Shift',
                lessonAddUpperRow: 'Add Upper Row',
                lessonAddLowerRow: 'Add Lower Row',
                // Lesson names - 2-layer
                lessonEssentialPhonemes: 'Essential Phonemes',
                lessonVowelVoyage: 'Vowel Voyage',
                lessonConsonantCommand: 'Consonant Command',
                lessonLigaturePower: 'Ligature Power',
                lessonShiftMastery: 'Shift Mastery',
                lessonCompleteControl: 'Complete Control',
                // Lesson names - JAFL
                lessonCoreFoundation: 'Core Foundation',
                lessonHomeSweet: 'Home Sweet Home',
                lessonUpperExpedition: 'Upper Expedition',
                lessonLowerExploration: 'Lower Exploration',
                lessonShiftIntroduction: 'Shift Introduction',
                lessonMasterTypist: 'Master Typist',
                instructions: 'Type the word shown above. Press Enter or Space to move to the next word.',
                congratulations: 'Congratulations!',
                completed30: 'You completed 30 words!',
                accuracy_final: 'Accuracy:',
                highScore: 'High Score:',
                levelReached: 'Level Reached:',
                practiceAgain: 'Practice Again',
                settingsTitle: 'Settings',
                displayShavian: 'Display UI in Shavian',
                displayShavianDesc: 'Show labels and text in Shavian alphabet instead of Latin',
                close: 'Close'
            },
            shavian: {
                title: '¬∑êëñêë∑ êëëêë≤êëê',
                subtitle: '¬∑êëñêë±êëùêëæêëØ Typing Practice',
                practice: 'êëêêëÆêë®êëíêëëêë¶êëï',
                play: 'êëêêë§êë±',
                settings: 'êëïêëßêëëêë¶êëôêëü',
                keyboardLayout: 'êëíêë∞êëöêë™êëÆêëõ êë§êë±êë¨êëë',
                ligatures: 'êë∑êëëêë©êë•êëßêëëêë¶êëí êë§êë¶êëúêë©êëóêëºêëü (êë©+êëÆ‚Üíêëº, êëò+êëµ‚Üíêëø)',
                lesson: 'êë§êëßêëïêë©êëØ:',
                auto: 'êë∑êëëêë¥ (êëêêëÆêë¥êëúêëÆêëßêëï êëöêë±êëïêëë)',
                wordLength: 'êë¢êëªêëõ êë§êëßêëôêëî:',
                characters: 'êëíêë®êëÆêë©êëíêëëêëºêëü',
                // Word length options
                length1: '1 êëíêë®êëÆêë©êëíêëëêëº',
                length2: '2 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length3: '3 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length4: '4 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length5: '5 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length6: '6 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length7: '7 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length46: '4-6 êëíêë®êëÆêë©êëíêëëêëºêëü',
                length57: '5-7 êëíêë®êëÆêë©êëíêëëêëºêëü',
                lesson_label: 'êë§êëßêëïêë©êëØ',
                level_label: 'êë§êëßêëùêë©êë§',
                words: 'êë¢êëªêëõêëü',
                accuracy: 'êë®êëíêëòêë´êëÆêë©êëïêë¶',
                // Lesson names - Imperial
                lessonHomeRowCenter: 'êë£êë¥êë• êëÆêë¥ êëïêëßêëØêëëêëº',
                lessonFullHomeRow: 'êëìêë´êë§ êë£êë¥êë• êëÆêë¥',
                lessonIndexFingerReach: 'êë¶êëØêëõêëßêëíêëï êëìêë¶êëôêëúêëº êëÆêë∞êëó',
                lessonUpperLowerRows: 'êë≥êëêêëº & êë§êë¥êëº êëÆêë¥êëü',
                lessonAlmostComplete: 'êë∑êë§êë•êë¥êëïêëë êëíêë©êë•êëêêë§êë∞êëë',
                lessonAllKeys: 'êë∑êë§ êëíêë∞êëü',
                lessonCompoundLetters: 'êëíêë™êë•êëêêë¨êëØêëõ êë§êëßêëëêëºêëü',
                // Lesson names - QWERTY
                lessonHomeRowShift: 'êë£êë¥êë• êëÆêë¥ + êëñêë¶êëìêëë',
                lessonAddUpperRow: 'êë®êëõ êë≥êëêêëº êëÆêë¥',
                lessonAddLowerRow: 'êë®êëõ êë§êë¥êëº êëÆêë¥',
                // Lesson names - 2-layer
                lessonEssentialPhonemes: 'êëßêëïêëßêëØêëñêë©êë§ êëìêë¥êëØêë∞êë•êëü',
                lessonVowelVoyage: 'êëùêë¨êë©êë§ êëùêë∂êëæêë°',
                lessonConsonantCommand: 'êëíêë™êëØêëïêë©êëØêë©êëØêëë êëíêë©êë•êë≠êëØêëõ',
                lessonLigaturePower: 'êë§êë¶êëúêë©êëóêëº êëêêë¨êëº',
                lessonShiftMastery: 'êëñêë¶êëìêëë êë•êë≠êëïêëëêëºêë¶',
                lessonCompleteControl: 'êëíêë©êë•êëêêë§êë∞êëë êëíêë©êëØêëëêëÆêë¥êë§',
                // Lesson names - JAFL
                lessonCoreFoundation: 'êëíêëπ êëìêë¨êëØêëõêë±êëñêë©êëØ',
                lessonHomeSweet: 'êë£êë¥êë• êëïêë¢êë∞êëë êë£êë¥êë•',
                lessonUpperExpedition: 'êë≥êëêêëº êëßêëíêëïêëêêë©êëõêë¶êëñêë©êëØ',
                lessonLowerExploration: 'êë§êë¥êëº êëßêëíêëïêëêêë§êëºêë±êëñêë©êëØ',
                lessonShiftIntroduction: 'êëñêë¶êëìêëë êë¶êëØêëëêëÆêë©êëõêë≥êëíêëñêë©êëØ',
                lessonMasterTypist: 'êë•êë≠êëïêëëêëº êëëêë≤êëêêë¶êëïêëë',
                instructions: 'êëëêë≤êëê êëû êë¢êëªêëõ êëñêë¥êëØ êë©êëöêë≥êëù. êëêêëÆêëßêëï êëßêëØêëëêëº êëπ êëïêëêêë±êëï êëë êë•êëµêëù êëë êëû êëØêëßêëíêëïêëë êë¢êëªêëõ.',
                congratulations: 'êëíêë©êëôêëúêëÆêë®êëóêë´êë§êë±êëñêë©êëØêëü!',
                completed30: 'êëø êëíêë©êë•êëêêë§êë∞êëëêë©êëõ 30 êë¢êëªêëõêëü!',
                accuracy_final: 'êë®êëíêëòêë´êëÆêë©êëïêë¶:',
                highScore: 'êë£êë≤ êëïêëíêëπ:',
                levelReached: 'êë§êëßêëùêë©êë§ êëÆêë∞êëóêëë:',
                practiceAgain: 'êëêêëÆêë®êëíêëëêë¶êëï êë©êëúêë±êëØ',
                settingsTitle: 'êëïêëßêëëêë¶êëôêëü',
                displayShavian: 'êëõêë¶êëïêëêêë§êë± UI êë¶êëØ ¬∑êëñêë±êëùêëæêëØ',
                displayShavianDesc: 'êëñêë¥ êë§êë±êëöêë©êë§êëü êëØ êëëêëßêëíêëïêëë êë¶êëØ ¬∑êëñêë±êëùêëæêëØ êë®êë§êëìêë©êëöêëßêëë êë¶êëØêëïêëëêëßêëõ êëù ¬∑êë§êë®êëëêë¶êëØ',
                close: 'êëíêë§êë¥êëü'
            }
        };

        const wordDisplay = document.getElementById('wordDisplay');
        const typingInput = document.getElementById('typingInput');
        const wordCountEl = document.getElementById('wordCount');
        const accuracyEl = document.getElementById('accuracy');
        const levelDisplayEl = document.getElementById('levelDisplay');

        // Get current level based on words completed (5 words per level)
        function getCurrentLevel() {
            if (currentMode === 'learn' && currentLayout === 'imperial' && useLigatures) {
                // Imperial with ligatures has 7 levels (compound letters at level 5)
                if (wordsCompleted < 5) return 1;
                if (wordsCompleted < 10) return 2;
                if (wordsCompleted < 15) return 3;
                if (wordsCompleted < 20) return 4;
                if (wordsCompleted < 25) return 5; // Compound letters lesson
                if (wordsCompleted < 30) return 6; // Almost Complete
                return 7; // All Keys
            } else {
                // Other modes use 6 levels (5 words per level = 30 words total)
                if (wordsCompleted < 5) return 1;
                if (wordsCompleted < 10) return 2;
                if (wordsCompleted < 15) return 3;
                if (wordsCompleted < 20) return 4;
                if (wordsCompleted < 25) return 5;
                return 6;
            }
        }

        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('currentMode', currentMode);

            // Update button states
            document.getElementById('learnBtn').classList.toggle('active', mode === 'learn');
            document.getElementById('playBtn').classList.toggle('active', mode === 'play');

            // Show/hide selectors
            document.getElementById('learnLevelInfo').style.display =
                mode === 'learn' ? 'block' : 'none';

            // Update stat label based on mode
            updateUILanguage();

            // Reset and reload
            resetPractice();
        }

        function onDialectChangeSettings() {
            const selected = document.querySelector('input[name="dialectSettings"]:checked');
            if (selected) {
                currentDialect = selected.value;
                localStorage.setItem('dialect', currentDialect);
                // Reload words with new dialect
                loadWords().then(() => {
                    updateLevelSelector();
                    loadNewWord();
                });
            }
        }

        function onLayoutChangeSettings() {
            currentLayout = document.getElementById('layoutSelectSettings').value;
            localStorage.setItem('keyboardLayout', currentLayout);
            // Show/hide ligature toggle based on layout
            // Only show for imperial, qwerty, and jafl
            const supportsLigatures = currentLayout === 'imperial' ||
                                     currentLayout === 'qwerty' ||
                                     currentLayout === 'jafl';
            document.getElementById('ligatureSettingOption').style.display =
                supportsLigatures ? 'block' : 'none';
            updateLevelSelector();
            loadNewWord();
        }

        function onLigatureToggleSettings() {
            useLigatures = document.getElementById('ligatureToggleSettings').checked;
            localStorage.setItem('useLigatures', useLigatures);
            updateLevelSelector();
            loadNewWord();
        }

        function onLevelChange() {
            selectedLevel = document.getElementById('levelSelect').value;
            loadNewWord();
        }

        function translateLessonName(name) {
            const lang = useShavianUI ? 'shavian' : 'latin';
            const t = translations[lang];

            // Map English lesson names to translation keys
            const nameMap = {
                'Home Row Center': t.lessonHomeRowCenter,
                'Full Home Row': t.lessonFullHomeRow,
                'Index Finger Reach': t.lessonIndexFingerReach,
                'Upper & Lower Rows': t.lessonUpperLowerRows,
                'Almost Complete': t.lessonAlmostComplete,
                'All Keys': t.lessonAllKeys,
                'Compound Letters': t.lessonCompoundLetters,
                'Home Row + Shift': t.lessonHomeRowShift,
                'Add Upper Row': t.lessonAddUpperRow,
                'Add Lower Row': t.lessonAddLowerRow,
                'Essential Phonemes': t.lessonEssentialPhonemes,
                'Vowel Voyage': t.lessonVowelVoyage,
                'Consonant Command': t.lessonConsonantCommand,
                'Ligature Power': t.lessonLigaturePower,
                'Shift Mastery': t.lessonShiftMastery,
                'Complete Control': t.lessonCompleteControl,
                'Core Foundation': t.lessonCoreFoundation,
                'Home Sweet Home': t.lessonHomeSweet,
                'Upper Expedition': t.lessonUpperExpedition,
                'Lower Exploration': t.lessonLowerExploration,
                'Shift Introduction': t.lessonShiftIntroduction,
                'Master Typist': t.lessonMasterTypist
            };

            return nameMap[name] || name;
        }

        function updateLevelSelector() {
            const levelSelect = document.getElementById('levelSelect');

            // Get the appropriate word list for current settings
            let learnWords;
            if (currentLayout === 'imperial') {
                learnWords = useLigatures ? learnWordsImperial : learnWordsImperialNoLig;
            } else if (currentLayout === 'qwerty') {
                learnWords = learnWordsQwerty;
            } else if (currentLayout === '2layer') {
                learnWords = learnWords2layer;
            } else if (currentLayout === 'jafl') {
                learnWords = useLigatures ? learnWordsJafl : learnWordsJaflNoLig;
            }

            // Clear existing options except "Auto"
            const lang = useShavianUI ? 'shavian' : 'latin';
            const t = translations[lang];
            levelSelect.innerHTML = `<option value="auto">${t.auto}</option>`;

            // Add lesson options with names
            if (learnWords) {
                const maxLevel = (currentLayout === 'imperial' && useLigatures) ? 7 : 6;

                for (let i = 1; i <= maxLevel; i++) {
                    // For Imperial with ligatures, insert compound letters at position 5
                    if (currentLayout === 'imperial' && useLigatures && i === 5 && learnWordsCompound[1]) {
                        const option = document.createElement('option');
                        option.value = 5;
                        const translatedName = translateLessonName(learnWordsCompound[1].name);
                        option.textContent = `5. ${translatedName}`;
                        levelSelect.appendChild(option);
                    } else {
                        // Map levels for Imperial with ligatures: 6‚Üí5, 7‚Üí6
                        const actualLevel = (currentLayout === 'imperial' && useLigatures && i > 5) ? i - 1 : i;
                        const levelData = learnWords[actualLevel];
                        if (levelData) {
                            const option = document.createElement('option');
                            option.value = i;
                            const translatedName = translateLessonName(levelData.name);
                            option.textContent = `${i}. ${translatedName}`;
                            levelSelect.appendChild(option);
                        }
                    }
                }
            }

            // Reset to auto if selected level is now unavailable
            const maxLevel = (currentLayout === 'imperial' && useLigatures) ? 7 : 6;
            if (selectedLevel !== 'auto' && parseInt(selectedLevel) > maxLevel) {
                selectedLevel = 'auto';
            }

            // Restore selected value
            levelSelect.value = selectedLevel;
        }

        // Get available words for current mode
        function getWordPool() {
            let pool = [];

            if (currentMode === 'learn') {
                // Learn mode: use keyboard-based progressive levels
                // Use selected level if not auto, otherwise calculate from progress
                const currentLvl = selectedLevel === 'auto' ? getCurrentLevel() : parseInt(selectedLevel);
                let learnWords;
                let level = currentLvl;

                // Check if we're in compound letters lesson
                if (currentLayout === 'imperial' && useLigatures && currentLvl === 5) {
                    learnWords = learnWordsCompound;
                    level = 1; // Compound lesson only has level 1
                } else {
                    if (currentLayout === 'imperial') {
                        learnWords = useLigatures ? learnWordsImperial : learnWordsImperialNoLig;
                    } else if (currentLayout === 'qwerty') {
                        learnWords = learnWordsQwerty;
                    } else if (currentLayout === '2layer') {
                        learnWords = learnWords2layer;
                    } else if (currentLayout === 'jafl') {
                        learnWords = useLigatures ? learnWordsJafl : learnWordsJaflNoLig;
                    }

                    // For Imperial with ligatures, adjust level mapping after compound letters
                    if (currentLayout === 'imperial' && useLigatures && currentLvl > 5) {
                        level = currentLvl - 1; // Map level 6 ‚Üí 5 (Almost Complete), level 7 ‚Üí 6 (All Keys)
                    } else {
                        level = Math.min(currentLvl, 6);
                    }
                }

                const levelData = learnWords[level];
                if (levelData && levelData.words) {
                    pool = levelData.words;
                    // Update level info display
                    document.getElementById('learnLevelName').textContent =
                        `Level ${currentLvl}: ${levelData.name}`;
                    document.getElementById('learnLevelDesc').textContent =
                        levelData.description;
                }
            } else {
                // Play mode: use level-based selection
                const level = getCurrentLevel();

                if (level === 1) {
                    // Level 1: 1-2 character words
                    pool = [...wordsByLength[1], ...wordsByLength[2]];
                } else if (level === 2) {
                    // Level 2: 2-3 character words
                    pool = [...wordsByLength[2], ...wordsByLength[3]];
                } else if (level === 3) {
                    // Level 3: 3-4 character words
                    pool = [...wordsByLength[3], ...wordsByLength[4]];
                } else if (level === 4) {
                    // Level 4: 4-6 character words
                    pool = [...wordsByLength[4], ...wordsByLength[5], ...wordsByLength[6]];
                } else {
                    // Level 5: 5+ character words
                    pool = [...wordsByLength[5], ...wordsByLength[6], ...wordsByLength[7]];
                }
            }

            return pool;
        }

        // Load words from JSON
        async function loadWords() {
            try {
                // Load practice words
                const wordsResponse = await fetch(`words_${currentDialect}.json`);
                const wordsData = await wordsResponse.json();
                // Convert string keys to numbers
                Object.keys(wordsData).forEach(key => {
                    wordsByLength[parseInt(key)] = wordsData[key];
                });

                // Load learn mode words for Imperial
                const learnImperialResponse = await fetch(`learn_words_imperial_${currentDialect}.json`);
                const learnImperialData = await learnImperialResponse.json();
                // Convert string keys to numbers
                Object.keys(learnImperialData).forEach(key => {
                    learnWordsImperial[parseInt(key)] = learnImperialData[key];
                });

                // Load learn mode words for QWERTY
                const learnQwertyResponse = await fetch(`learn_words_qwerty_${currentDialect}.json`);
                const learnQwertyData = await learnQwertyResponse.json();
                // Convert string keys to numbers
                Object.keys(learnQwertyData).forEach(key => {
                    learnWordsQwerty[parseInt(key)] = learnQwertyData[key];
                });

                // Load learn mode words for Imperial (no ligatures)
                const learnImperialNoLigResponse = await fetch(`learn_words_imperial_${currentDialect}_no_lig.json`);
                const learnImperialNoLigData = await learnImperialNoLigResponse.json();
                // Convert string keys to numbers
                Object.keys(learnImperialNoLigData).forEach(key => {
                    learnWordsImperialNoLig[parseInt(key)] = learnImperialNoLigData[key];
                });

                // Load compound letters lesson
                const learnCompoundResponse = await fetch(`learn_words_compound_${currentDialect}.json`);
                const learnCompoundData = await learnCompoundResponse.json();
                // Convert string keys to numbers
                Object.keys(learnCompoundData).forEach(key => {
                    learnWordsCompound[parseInt(key)] = learnCompoundData[key];
                });

                // Load learn mode words for Shaw 2-layer
                const learn2layerResponse = await fetch(`learn_words_2layer_${currentDialect}.json`);
                const learn2layerData = await learn2layerResponse.json();
                // Convert string keys to numbers
                Object.keys(learn2layerData).forEach(key => {
                    learnWords2layer[parseInt(key)] = learn2layerData[key];
                });

                // Load learn mode words for Shaw-JAFL (with ligatures)
                const learnJaflResponse = await fetch(`learn_words_jafl_${currentDialect}.json`);
                const learnJaflData = await learnJaflResponse.json();
                // Convert string keys to numbers
                Object.keys(learnJaflData).forEach(key => {
                    learnWordsJafl[parseInt(key)] = learnJaflData[key];
                });

                // Load learn mode words for Shaw-JAFL (no ligatures)
                const learnJaflNoLigResponse = await fetch(`learn_words_jafl_${currentDialect}_no_lig.json`);
                const learnJaflNoLigData = await learnJaflNoLigResponse.json();
                // Convert string keys to numbers
                Object.keys(learnJaflNoLigData).forEach(key => {
                    learnWordsJaflNoLig[parseInt(key)] = learnJaflNoLigData[key];
                });

                wordsLoaded = true;
                return true;
            } catch (error) {
                console.error('Failed to load words:', error);
                alert('Failed to load word list. Please refresh the page.');
                return false;
            }
        }

        // Initialize
        async function init() {
            await loadWords();
            if (wordsLoaded) {
                updateLevelSelector(); // Populate lesson dropdown

                // Check if we should show welcome screen
                const welcomeShown = localStorage.getItem('welcomeShown');
                if (!welcomeShown) {
                    showWelcomeIfNeeded();
                } else {
                    loadNewWord();
                    typingInput.focus();
                }
            }
        }

        function loadNewWord() {
            const pool = getWordPool();

            // Avoid recently used words (keep history of last 10 words)
            const historySize = Math.min(10, Math.floor(pool.length / 2));
            let newWord;
            let attempts = 0;
            const maxAttempts = 50;

            do {
                newWord = pool[Math.floor(Math.random() * pool.length)];
                attempts++;
            } while (recentWords.includes(newWord) && attempts < maxAttempts);

            currentWord = newWord;

            // Update recent words history
            recentWords.push(currentWord);
            if (recentWords.length > historySize) {
                recentWords.shift(); // Remove oldest word
            }

            typingInput.value = '';
            previousInput = ''; // Reset previous input for new word
            hasPendingLigature = false; // Reset pending ligature for new word
            updateWordDisplay();
            updateLevel();
        }

        function updateLevel() {
            const newLevel = getCurrentLevel();
            if (newLevel !== currentLevel) {
                // Save stats for the completed level
                const levelAccuracy = currentLevelLettersTyped === 0 ? 100.0 :
                    ((currentLevelCorrectLetters / currentLevelLettersTyped) * 100);
                levelStats.push({
                    level: currentLevel,
                    accuracy: levelAccuracy,
                    lettersTyped: currentLevelLettersTyped,
                    correctLetters: currentLevelCorrectLetters
                });

                // Reset current level stats
                currentLevelLettersTyped = 0;
                currentLevelCorrectLetters = 0;

                currentLevel = newLevel;
            }

            // Show '-' for practice mode, otherwise show the level/lesson number
            if (currentMode === 'practice') {
                levelDisplayEl.textContent = '-';
            } else {
                levelDisplayEl.textContent = currentLevel;
            }
        }

        function updateWordDisplay() {
            const userInput = typingInput.value;
            let html = '';

            // Convert to arrays of actual Unicode characters (not code units)
            const wordChars = Array.from(currentWord);
            const inputChars = Array.from(userInput);

            // Expand both to component characters for comparison
            const wordExpanded = expandLigatures(currentWord);
            const inputExpanded = expandLigatures(userInput);

            // Track position in expanded form
            let expandedPos = 0;

            for (let i = 0; i < wordChars.length; i++) {
                const char = wordChars[i];
                let className = '';

                // Determine how many expanded characters this display character represents
                const isLigature = LIGATURES[char];
                const expandedLen = isLigature ? 2 : 1;

                // Check if all the expanded characters for this display char have been typed correctly
                let allCorrect = true;
                let anyTyped = false;
                let anyIncorrect = false;

                for (let j = 0; j < expandedLen; j++) {
                    const expIdx = expandedPos + j;
                    if (expIdx < inputExpanded.length) {
                        anyTyped = true;
                        if (inputExpanded[expIdx] !== wordExpanded[expIdx]) {
                            anyIncorrect = true;
                            allCorrect = false;
                        }
                    } else {
                        allCorrect = false;
                    }
                }

                // Set class based on match status
                if (anyIncorrect) {
                    className = 'incorrect';
                } else if (anyTyped && allCorrect) {
                    className = 'correct';
                }
                // If partially typed but not incorrect, show no class (pending)

                html += `<span class="char ${className}">${char}</span>`;
                expandedPos += expandedLen;
            }

            wordDisplay.innerHTML = html;
        }

        function updateStats() {
            wordCountEl.textContent = wordsCompleted;
            const accuracy = totalLettersTyped === 0 ? 100 : ((correctLetters / totalLettersTyped) * 100).toFixed(1);
            accuracyEl.textContent = accuracy + '%';
        }

        function checkCompletion() {
            const userInput = typingInput.value;

            // Compare expanded forms to handle ligature equivalence
            const inputExpanded = expandLigatures(userInput);
            const wordExpanded = expandLigatures(currentWord);

            // Check if expanded forms match
            if (inputExpanded.length === wordExpanded.length &&
                inputExpanded.every((char, i) => char === wordExpanded[i])) {
                // Word completed correctly
                wordsCompleted++;
                updateStats();

                // Check if reached 30 words (6 levels √ó 5 words)
                if (wordsCompleted === 30) {
                    showCompletionModal();
                } else {
                    // Load new word after a short delay
                    setTimeout(() => {
                        loadNewWord();
                    }, 200);
                }
            }
        }

        function showCompletionModal() {
            // Save stats for the final level
            const finalLevelAccuracy = currentLevelLettersTyped === 0 ? 100.0 :
                ((currentLevelCorrectLetters / currentLevelLettersTyped) * 100);
            levelStats.push({
                level: currentLevel,
                accuracy: finalLevelAccuracy,
                lettersTyped: currentLevelLettersTyped,
                correctLetters: currentLevelCorrectLetters
            });

            const accuracy = totalLettersTyped === 0 ? 100.0 : ((correctLetters / totalLettersTyped) * 100);
            const accuracyFormatted = accuracy.toFixed(1) + '%';

            // Update high score if current score is better
            if (accuracy > highScore) {
                highScore = accuracy;
                localStorage.setItem('highScore', highScore.toString());
            }

            document.getElementById('finalScore').textContent = accuracyFormatted;
            document.getElementById('finalAccuracy').textContent = accuracyFormatted;
            document.getElementById('finalLevel').textContent = currentLevel;

            // Update high score display
            const highScoreFormatted = highScore.toFixed(1) + '%';
            document.getElementById('finalHighScore').textContent = highScoreFormatted;

            // Generate per-level stats HTML
            const lang = useShavianUI ? 'shavian' : 'latin';
            const t = translations[lang];
            let levelStatsHTML = '';
            levelStats.forEach(stat => {
                const levelAccuracyFormatted = stat.accuracy.toFixed(1);
                const levelLabel = currentMode === 'learn' ? t.lesson_label : t.level_label;
                levelStatsHTML += `<div class="level-stat">${levelLabel} ${stat.level}: ${levelAccuracyFormatted}%</div>`;
            });
            document.getElementById('levelStatsContainer').innerHTML = levelStatsHTML;

            document.getElementById('completionModal').classList.add('show');
        }

        function resetPractice() {
            // Reset all stats
            wordsCompleted = 0;
            totalLettersTyped = 0;
            correctLetters = 0;
            currentLevel = 1;
            recentWords = [];
            levelStats = [];
            currentLevelLettersTyped = 0;
            currentLevelCorrectLetters = 0;
            hasPendingLigature = false;

            // Hide modal
            document.getElementById('completionModal').classList.remove('show');

            // Update display
            updateStats();
            updateLevel();
            loadNewWord();
            typingInput.focus();
        }

        // Event listeners
        let previousInput = '';
        let hasPendingLigature = false; // Track if last character was a ligature candidate

        typingInput.addEventListener('input', (e) => {
            let userInput = e.target.value;

            // Check if we can form a ligature from the last two characters (always)
            const inputChars = Array.from(userInput);
            if (inputChars.length >= 2) {
                const lastTwo = inputChars[inputChars.length - 2] + inputChars[inputChars.length - 1];
                if (COMPONENT_TO_LIGATURE[lastTwo]) {
                    // Form the ligature
                    const beforeLigature = inputChars.slice(0, -2).join('');
                    const compound = COMPONENT_TO_LIGATURE[lastTwo];
                    userInput = beforeLigature + compound;
                    typingInput.value = userInput;
                    console.log('Ligature formed:', lastTwo, '‚Üí', compound);
                }
            }

            // Expand to component characters for accurate tracking
            const inputExpanded = expandLigatures(userInput);
            const prevInputExpanded = expandLigatures(previousInput);
            const wordExpanded = expandLigatures(currentWord);

            // Handle backspace - resolve pending ligature as incorrect
            if (inputExpanded.length < prevInputExpanded.length && hasPendingLigature) {
                // User backspaced while a ligature candidate was pending - count it as wrong
                totalLettersTyped++;
                currentLevelLettersTyped++;
                hasPendingLigature = false;
            }

            // Track letter-level accuracy at the expanded character level
            // Only count new expanded characters typed (not backspaces)
            if (inputExpanded.length > prevInputExpanded.length) {
                const expandedIndex = prevInputExpanded.length;

                // Check if we're resolving a pending ligature
                if (hasPendingLigature) {
                    totalLettersTyped++;
                    currentLevelLettersTyped++;

                    // Check if this completes the ligature correctly
                    if (expandedIndex < wordExpanded.length &&
                        inputExpanded[expandedIndex] === wordExpanded[expandedIndex]) {
                        // Ligature completed correctly - count both characters as correct
                        correctLetters += 2;
                        currentLevelCorrectLetters += 2;
                    } else {
                        // Wrong continuation - the pending character was wrong
                        totalLettersTyped++;
                        currentLevelLettersTyped++;
                    }
                    hasPendingLigature = false;
                } else {
                    // Check if this could be the start of a ligature candidate
                    // Look ahead to see if the next two characters form a known ligature
                    let isLigatureCandidate = false;
                    if (expandedIndex < wordExpanded.length - 1) {
                        const twoChars = wordExpanded[expandedIndex] + wordExpanded[expandedIndex + 1];
                        isLigatureCandidate = COMPONENT_TO_LIGATURE[twoChars] !== undefined;
                    }

                    if (expandedIndex < wordExpanded.length &&
                        inputExpanded[expandedIndex] === wordExpanded[expandedIndex] &&
                        isLigatureCandidate) {
                        // This is a potential ligature start - mark as pending, don't count yet
                        hasPendingLigature = true;
                    } else {
                        // Normal character - count it now
                        totalLettersTyped++;
                        currentLevelLettersTyped++;

                        if (expandedIndex < wordExpanded.length &&
                            inputExpanded[expandedIndex] === wordExpanded[expandedIndex]) {
                            correctLetters++;
                            currentLevelCorrectLetters++;
                        }
                    }
                }
            }

            // Use typingInput.value in case we replaced a ligature
            previousInput = typingInput.value;
            updateWordDisplay();
            updateStats();
            checkCompletion();
        });

        typingInput.addEventListener('keydown', (e) => {
            // Allow Enter or Space to advance - but only if word is correct
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const userInput = typingInput.value.trim();

                if (userInput.length > 0) {
                    // Check if word is correct using expanded forms
                    const inputExpanded = expandLigatures(userInput);
                    const wordExpanded = expandLigatures(currentWord);

                    // Only advance if the word matches exactly
                    if (inputExpanded.length === wordExpanded.length &&
                        inputExpanded.every((char, i) => char === wordExpanded[i])) {
                        // Resolve any pending ligature as correct
                        if (hasPendingLigature) {
                            // The pending ligature was correct
                            hasPendingLigature = false;
                        }

                        wordsCompleted++;
                        updateStats();
                        loadNewWord();
                    }
                    // If word doesn't match, do nothing - user must keep typing or fix it
                }
            }
        });

        // Burger menu functions
        function toggleBurgerMenu() {
            const dropdown = document.getElementById('burgerDropdown');
            dropdown.classList.toggle('show');
        }

        function closeBurgerMenu() {
            const dropdown = document.getElementById('burgerDropdown');
            dropdown.classList.remove('show');
        }

        // Close burger menu if clicking outside
        window.addEventListener('click', function(e) {
            if (!e.target.matches('.burger-btn') && !e.target.closest('.burger-menu')) {
                closeBurgerMenu();
            }
        });

        // Content modal functions
        async function openContentModal(page) {
            closeBurgerMenu();

            const modal = document.getElementById('contentModal');
            const titleEl = document.getElementById('contentModalTitle');
            const bodyEl = document.getElementById('contentModalBody');

            // Set title
            titleEl.textContent = page.charAt(0).toUpperCase() + page.slice(1);
            bodyEl.innerHTML = 'Loading...';

            // Show modal
            modal.classList.add('show');

            // Load content based on current language
            const lang = useShavianUI ? 'shavian' : 'latin';
            const filename = `${page}_${lang}.html`;

            try {
                const response = await fetch(filename);
                if (response.ok) {
                    const html = await response.text();
                    bodyEl.innerHTML = html;
                } else {
                    bodyEl.innerHTML = '<p>Content not found.</p>';
                }
            } catch (error) {
                bodyEl.innerHTML = '<p>Error loading content.</p>';
                console.error('Error loading content:', error);
            }
        }

        function closeContentModal() {
            document.getElementById('contentModal').classList.remove('show');
        }

        // Welcome modal functions
        function onDialectChangeWelcome() {
            const selected = document.querySelector('input[name="dialectWelcome"]:checked');
            if (selected) {
                currentDialect = selected.value;
                localStorage.setItem('dialect', currentDialect);
                // Reload words with new dialect
                loadWords().then(() => {
                    updateLevelSelector();
                    loadNewWord();
                });
            }
        }

        function onLayoutChangeWelcome() {
            currentLayout = document.getElementById('layoutSelectWelcome').value;
            localStorage.setItem('keyboardLayout', currentLayout);

            // Show/hide ligature toggle
            const supportsLigatures = currentLayout === 'imperial' || currentLayout === 'qwerty' || currentLayout === 'jafl';
            document.getElementById('ligatureWelcomeOption').style.display = supportsLigatures ? 'block' : 'none';
        }

        function onLigatureToggleWelcome() {
            useLigatures = document.getElementById('ligatureToggleWelcome').checked;
            localStorage.setItem('useLigatures', useLigatures);
        }

        function toggleShavianUIWelcome() {
            useShavianUI = document.getElementById('shavianUIToggleWelcome').checked;
            localStorage.setItem('useShavianUI', useShavianUI);
            updateUILanguage();
        }

        function closeWelcomeModal() {
            localStorage.setItem('welcomeShown', 'true');
            document.getElementById('welcomeModal').classList.remove('show');
            updateLevelSelector();
            loadNewWord();
            typingInput.focus();
        }

        function showWelcomeIfNeeded() {
            const welcomeShown = localStorage.getItem('welcomeShown');
            if (!welcomeShown) {
                // Sync welcome modal with current settings
                const dialectRadio = document.querySelector(`input[name="dialectWelcome"][value="${currentDialect}"]`);
                if (dialectRadio) dialectRadio.checked = true;

                document.getElementById('layoutSelectWelcome').value = currentLayout;
                document.getElementById('ligatureToggleWelcome').checked = useLigatures;
                document.getElementById('shavianUIToggleWelcome').checked = useShavianUI;

                // Show/hide ligature option
                const supportsLigatures = currentLayout === 'imperial' || currentLayout === 'qwerty' || currentLayout === 'jafl';
                document.getElementById('ligatureWelcomeOption').style.display = supportsLigatures ? 'block' : 'none';

                document.getElementById('welcomeModal').classList.add('show');
            }
        }

        function resetWelcomeScreen() {
            localStorage.removeItem('welcomeShown');
            closeSettings();
            showWelcomeIfNeeded();
        }

        // Settings functions
        function openSettings() {
            // Sync settings with current state
            const dialectRadio = document.querySelector(`input[name="dialectSettings"][value="${currentDialect}"]`);
            if (dialectRadio) dialectRadio.checked = true;

            document.getElementById('layoutSelectSettings').value = currentLayout;
            document.getElementById('ligatureToggleSettings').checked = useLigatures;

            // Show/hide ligature option based on current layout
            const supportsLigatures = currentLayout === 'imperial' ||
                                     currentLayout === 'qwerty' ||
                                     currentLayout === 'jafl';
            document.getElementById('ligatureSettingOption').style.display =
                supportsLigatures ? 'block' : 'none';

            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function toggleShavianUI() {
            useShavianUI = document.getElementById('shavianUIToggle').checked;
            localStorage.setItem('useShavianUI', useShavianUI);
            updateUILanguage();
        }

        function updateUILanguage() {
            const lang = useShavianUI ? 'shavian' : 'latin';
            const t = translations[lang];

            // Update title and subtitle
            document.querySelector('h1').textContent = t.title;
            document.querySelector('.subtitle').textContent = t.subtitle;

            // Update mode buttons
            document.getElementById('learnBtn').textContent = t.practice;
            document.getElementById('playBtn').textContent = t.play;

            // Update Learn mode labels
            document.querySelector('#learnLevelInfo label').textContent = t.lesson;

            // Update Practice mode label and options
            document.querySelector('#practiceLengthSelector label').textContent = t.wordLength;
            const lengthSelect = document.getElementById('lengthSelect');
            if (lengthSelect) {
                lengthSelect.options[0].textContent = t.length1;
                lengthSelect.options[1].textContent = t.length2;
                lengthSelect.options[2].textContent = t.length3;
                lengthSelect.options[3].textContent = t.length4;
                lengthSelect.options[4].textContent = t.length5;
                lengthSelect.options[5].textContent = t.length6;
                lengthSelect.options[6].textContent = t.length7;
                lengthSelect.options[7].textContent = t.length46;
                lengthSelect.options[8].textContent = t.length57;
            }

            // Update stats labels
            document.querySelector('.stat-label').textContent =
                currentMode === 'learn' ? t.lesson_label : t.level_label;
            document.querySelectorAll('.stat-label')[1].textContent = t.words;
            document.querySelectorAll('.stat-label')[2].textContent = t.accuracy;

            // Update instructions
            document.querySelector('.instructions').textContent = t.instructions;

            // Update completion modal
            document.querySelector('#completionModal h2').textContent = t.congratulations;
            document.querySelector('#completionModal p').textContent = t.completed30;
            document.querySelectorAll('.stat-row')[0].childNodes[0].textContent = t.accuracy_final + ' ';
            document.querySelectorAll('.stat-row')[1].childNodes[0].textContent = t.highScore + ' ';
            document.querySelectorAll('.stat-row')[2].childNodes[0].textContent = t.levelReached + ' ';
            document.querySelector('#completionModal button').textContent = t.practiceAgain;

            // Update settings modal
            document.querySelector('#settingsModal h2').textContent = t.settingsTitle;
            document.querySelector('#shavianUIToggle + span').textContent = t.displayShavian;
            document.querySelector('.settings-option-desc').textContent = t.displayShavianDesc;
            document.querySelector('.settings-close-btn').textContent = t.close;

            // Update settings labels
            document.querySelector('.settings-option label').textContent = t.keyboardLayout;
            document.querySelector('#ligatureToggleSettings + span').textContent = t.ligatures;

            // Update lesson dropdown Auto option
            const autoOption = document.querySelector('#levelSelect option[value="auto"]');
            if (autoOption) {
                autoOption.textContent = t.auto;
            }
        }

        // Load saved preferences
        function loadPreferences() {
            // Load Shavian UI preference
            const savedShavianUI = localStorage.getItem('useShavianUI');
            if (savedShavianUI !== null) {
                useShavianUI = savedShavianUI === 'true';
                document.getElementById('shavianUIToggle').checked = useShavianUI;
            }

            // Load dialect preference
            const savedDialect = localStorage.getItem('dialect');
            if (savedDialect !== null && (savedDialect === 'gb' || savedDialect === 'us')) {
                currentDialect = savedDialect;
            }

            // Load keyboard layout
            const savedLayout = localStorage.getItem('keyboardLayout');
            if (savedLayout !== null) {
                currentLayout = savedLayout;
            }

            // Load ligature preference
            const savedLigatures = localStorage.getItem('useLigatures');
            if (savedLigatures !== null) {
                useLigatures = savedLigatures === 'true';
            }

            // Load current mode
            const savedMode = localStorage.getItem('currentMode');
            if (savedMode !== null && (savedMode === 'learn' || savedMode === 'play')) {
                currentMode = savedMode;
                // Update button states
                document.getElementById('learnBtn').classList.remove('active');
                document.getElementById('playBtn').classList.remove('active');
                if (currentMode === 'learn') {
                    document.getElementById('learnBtn').classList.add('active');
                    document.getElementById('learnLevelInfo').style.display = 'block';
                } else if (currentMode === 'play') {
                    document.getElementById('playBtn').classList.add('active');
                }
            }

            // Load high score
            const savedHighScore = localStorage.getItem('highScore');
            if (savedHighScore !== null) {
                highScore = parseFloat(savedHighScore);
            }
        }

        // Start the app
        loadPreferences();
        init();
        updateUILanguage();
    </script>
</body>
</html>
